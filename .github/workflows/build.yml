name: Build fastregex

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-native:
    name: Build native lib (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build Rust library
      run: cargo build --release
      working-directory: rust

    - name: Prepare artifact directory
      shell: bash
      run: |
        OS_NAME=""
        case "${{ matrix.os }}" in
          ubuntu-latest)  OS_NAME="linux" ;;
          macos-latest)   OS_NAME="macos" ;;
          windows-latest) OS_NAME="windows" ;;
        esac

        # Determine arch
        ARCH_NAME=$(uname -m)
        if [[ "$ARCH_NAME" == "x86_64" ]] || [[ "$ARCH_NAME" == "amd64" ]]; then
          ARCH="x86_64"
        elif [[ "$ARCH_NAME" == "aarch64" ]] || [[ "$ARCH_NAME" == "arm64" ]]; then
          ARCH="aarch64"
        else
          ARCH="$ARCH_NAME"
        fi

        LIB_PREFIX="lib"
        LIB_EXT=".so"
        if [ "$OS_NAME" == "windows" ]; then
          LIB_PREFIX=""
          LIB_EXT=".dll"
        elif [ "$OS_NAME" == "macos" ]; then
          LIB_EXT=".dylib"
        fi

        LIB_NAME="${LIB_PREFIX}fastregex${LIB_EXT}"
        TARGET_DIR="native-libs/$OS_NAME-$ARCH"
        mkdir -p "$TARGET_DIR"
        cp "rust/target/release/$LIB_NAME" "$TARGET_DIR/"
        echo "OS_ARCH=$OS_NAME-$ARCH" >> $GITHUB_ENV

    - name: Upload native lib
      uses: actions/upload-artifact@v4
      with:
        name: native-lib-${{ env.OS_ARCH }}
        path: native-libs/

  package-jar:
    name: Package Multi-platform JAR
    needs: build-native
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Download all native libs
      uses: actions/download-artifact@v4
      with:
        pattern: native-lib-*
        path: java/me/naimad/fastregex/native_bin
        merge-multiple: true

    - name: Build and package JAR
      run: |
        cd java
        # Clean any potentially downloaded .class files (though unlikely)
        rm -f me/naimad/fastregex/*.class
        # Explicitly list all source files to ensure correct compilation of dependencies
        javac -d . me/naimad/fastregex/FastRegexLoader.java me/naimad/fastregex/FastRegex.java me/naimad/fastregex/Demo.java
        # Package classes and the package-relative native_bin directory
        jar cvf fastregex.jar me/naimad/fastregex/*.class me/naimad/fastregex/native_bin/
        mkdir -p ../dist
        cp fastregex.jar ../dist/

    - name: Upload final JAR
      uses: actions/upload-artifact@v4
      with:
        name: fastregex-jar
        path: dist/fastregex.jar
